<div class="graybar"></div>
<div class="container" id="containerdiv">
<h2 id="edit">New Entry</h2>
<p>Simply fill out the form below. All fields are mandatory. Once submitted, you will see a token that you can to modify your entry in the
future. If you modify your entry, make sure to supply the token you received when you created the entry.</p>
<form class="contactform">
	<ul>
		<li>
			<label for="title">Title (max. 140 chars)</label>
			<input required type="text" id="title" name="title" placeholder="Your game's name"  />
		</li>
		<li>
			<label for="creator">Creator (max. 140 chars)</label>
			<input required type="text" id="creator" name="creator" placeholder="Name of the game's creator"  />
		</li>
		<li>
			<label>Description (max. 1000 chars)</label>
			<textarea required id="description" placeholder="Describe your game, no markup allowed"></textarea>
		</li>
		<li>
			<label for="linkname">Link #1</label>
			<input required type="text" id="linkname" name="linkname0" placeholder="Name of the link, e.g. Play Store, Github, ..."  />
			<input required type="url" id="linkurl" name="linkurl0" placeholder="URL"  />
		</li>
		<li>
			<label for="linkname">Link #2</label>
			<input type="text" id="linkname" name="linkname1" placeholder="Name of the link, e.g. Play Store, Github, ..."  />
			<input type="url" id="linkurl" name="linkurl1" placeholder="URL"  />
		</li>
		<li>
			<label for="linkname">Link #3</label>
			<input type="text" id="linkname" name="linkname2" placeholder="Name of the link, e.g. Play Store, Github, ..."  />
			<input type="url" id="linkurl" name="linkurl2" placeholder="URL"  />
		</li>
		<li>
			<label for="linkname">Link #4</label>
			<input type="text" id="linkname" name="linkname3" placeholder="Name of the link, e.g. Play Store, Github, ..."  />
			<input type="url" id="linkurl" name="linkurl3" placeholder="URL"  />
		</li>
		<li>
			<label for="imageurl">Image</label>
			<input required type="url" id="imageurl" name="imageurl" placeholder="URL"  />
			<img id="preview"/>
		</li>
		<li><div id="tokendiv"></div></li>
		<li><div id="recaptcha"></div></li>
		<li><button id="submit" class="submit" type="submit">Submit</button></li>
	</ul>
</form>
<div id="result"></div>
</div>
<script type="text/javascript" src="http://www.google.com/recaptcha/api/js/recaptcha_ajax.js"></script>

<script>
var isCreate = true;

function loadGame(game) {
	isCreate = false;
	if(!game) return;
	$("#tokendiv").html('<label for="token">Token</label><input required id="token" name="token"/>');
	$("#title").attr("value", game.title);
	$("#creator").attr("value", game.creator);
	$("#description").val(game.description);
	$("#linkname").attr("value", game.downloadUrls[0].name);
	$("#linkurl").attr("value", game.downloadUrls[0].url);
	$("#imageurl").attr("value", game.imageUrls[0]);
	$("#preview").attr("src", game.imageUrls[0]);
	$("#edit").html("Edit Entry");
}

function saveGame() {
	var challenge = Recaptcha.get_challenge();
	var response = Recaptcha.get_response();
	var url = "http://" + window.location.host.split(":")[0] + ":7777/libgdx-site/service/";
	if(isCreate) url += "create";
	else url += "update";
	
	game = {
		title: $("#title").val(),
		creator: $("#creator").val(),
		description: $("#description").val(),
		imageUrls: [$("#imageurl").val()],
		downloadUrls: [{name: $("#linkname").val(), url: $("#linkurl").val()}]
	}
	
	$.ajax({
		type: "POST",
		url: url,
		contentType: "application/json",
		data: JSON.stringify({ 
			challenge: challenge,
			response: response,
			token: $("#token").val(),
			game: game,
		}), 
		success: processResponse,
		error: function() {
			$("#result").html("<h2>Sorry, server error<h2>");
		}
	});
}

function processResponse(data) {
	if(!data.success) {
		alert("Sorry, there was an error\n" + data.message);	
	} else {
		$("#containerdiv").empty();
		$("#containerdiv").html("<h2>Success! Token: " + data.token + ", save the token to be able to modify the entry later!<h2>"
						   + '<a href="showentry.html?id=' + data.gameId + '">To your entry</a>');
	}
}

$(document).ready(function() {
	var publicKey = "6LcY7OISAAAAAEWzUbJzDJXuy0I1UfpEdDuErm-g";
	Recaptcha.create(
		publicKey,
		"recaptcha",
		{
		  theme: "red",
		  callback: Recaptcha.focus_response_field
		}
	);
	
	var gameId = getParameterByName("id");
	if(gameId) {
		$.ajax({
			url: "http://" + window.location.host.split(":")[0] + ":7777/libgdx-site/service/game?id=" + gameId,
			success: loadGame,
			error: function() {
				isCreate = true;
			}
		});
	}
	
	$("#imageurl").change(function() {
		var url = $("#imageurl").val();
		console.log(url);
		if(url) $("#preview").attr("src", url);
	});
	
	$("form").submit(function() {
		saveGame();
		return false;
	});
});
</script>
